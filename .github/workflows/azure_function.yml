name: Azure Functions Deployment

on:
  push:
    branches: [main]
    paths:
      - 'api/**'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: 'cover-craft'
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'api'
  NODE_VERSION: '24.x' # Use LTS for better cache availability & stability

concurrency:
  group: cover-craft-function-deploy
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 1

      - name: Setup Node (${{ env.NODE_VERSION }}) with cache
        uses: actions/setup-node@v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/package-lock.json'

      - name: Install dependencies (clean & fast)
        working-directory: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        run: |
          npm ci --prefer-offline --no-audit --no-fund

      - name: Build (TypeScript -> JS)
        working-directory: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        run: |
          npm run build

      - name: Run tests (fail fast)
        working-directory: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        run: |
          npm test -- --run

      - name: Package for deployment
        working-directory: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        run: |
          # 1. Remove dev dependencies and install only production dependencies
          rm -rf node_modules
          npm install --omit=dev --no-audit --no-fund

          # 2. Create the zip file for deployment
          zip -r deploy.zip . -x local.settings.json

      - name: Azure Login
        uses: azure/login@v2.3.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Functions (Zip Push)
        run: |
          cd ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          az functionapp deployment source config-zip \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group personal-projects \
            --src ./deploy.zip

      - name: Post-deploy info
        run: |
          echo "Deployment completed at $(date -u)."
          echo "Zip size:" && ls -lh ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/deploy.zip
